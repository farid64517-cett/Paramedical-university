<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فحص إعداد قاعدة البيانات</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body class="check-setup-body">
    <div class="check-container">
        <h1>🔍 فحص إعداد قاعدة البيانات</h1>
        <p>هذه الصفحة تساعدك في التحقق من إعداد قاعدة البيانات بشكل صحيح</p>
        
        <div id="checkResults"></div>
        
        <button class="btn-check" onclick="runChecks()">بدء الفحص</button>
        <button class="btn-check btn-test-user" onclick="createTestUser()" id="createUserBtn">إنشاء مستخدم تجريبي</button>
        
        <div id="sqlInstructions">
            <h2>📋 تعليمات الإصلاح</h2>
            <p>انسخ الكود التالي والصقه في Supabase SQL Editor:</p>
            <button class="btn-check btn-copy-sql" onclick="copySQLCode()">📋 نسخ كود SQL</button>
            <div class="sql-code">
                <pre id="sqlCode">-- إنشاء جدول المستخدمين
CREATE TABLE IF NOT EXISTS public.users (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    full_name TEXT NOT NULL,
    role TEXT NOT NULL CHECK (role IN ('student', 'teacher', 'admin')),
    phone TEXT,
    university TEXT,
    department TEXT,
    year_of_study INTEGER,
    profile_image TEXT,
    bio TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT true,
    email_verified BOOLEAN DEFAULT false
);

-- تفعيل Row Level Security
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- إضافة قواعد RLS الأساسية
CREATE POLICY "Users can view own profile" ON public.users
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON public.users
    FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Enable insert for authenticated users only" ON public.users
    FOR INSERT WITH CHECK (auth.uid() = id);</pre>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="user-helper.js"></script>
    <script>
        async function runChecks() {
            const resultsDiv = document.getElementById('checkResults');
            resultsDiv.innerHTML = '<div class="check-item info"><span class="icon">⏳</span><span>جاري الفحص...</span></div>';
            
            const checks = [];
            
            // التحقق من وجود Supabase
            if (typeof supabase === 'undefined') {
                checks.push({
                    status: 'error',
                    icon: '❌',
                    message: 'Supabase غير محمل. تحقق من config.js'
                });
                displayResults(checks);
                return;
            }
            
            // 1. التحقق من الاتصال بـ Supabase
            try {
                // التحقق من المفتاح أولاً
                if (SUPABASE_ANON_KEY.includes('YOUR_ANON_KEY_HERE') || SUPABASE_ANON_KEY.includes('PLACEHOLDER')) {
                    checks.push({
                        status: 'error',
                        icon: '❌',
                        message: 'يجب تحديث SUPABASE_ANON_KEY في config.js بالمفتاح الصحيح من Supabase Dashboard'
                    });
                    document.getElementById('sqlInstructions').style.display = 'block';
                } else {
                    const { data: testData, error: testError } = await supabase.auth.getSession();
                    if (!testError) {
                        checks.push({
                            status: 'success',
                            icon: '✅',
                            message: 'الاتصال بـ Supabase يعمل بشكل صحيح'
                        });
                    } else {
                        checks.push({
                            status: 'error',
                            icon: '❌',
                            message: 'فشل الاتصال بـ Supabase: ' + testError.message
                        });
                    }
                }
            } catch (e) {
                checks.push({
                    status: 'error',
                    icon: '❌',
                    message: 'خطأ في الاتصال: ' + e.message
                });
            }
            
            // 2. التحقق من وجود جدول users
            let tableExists = false;
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        checks.push({
                            status: 'error',
                            icon: '❌',
                            message: 'جدول users غير موجود - يجب إنشاؤه'
                        });
                        document.getElementById('sqlInstructions').style.display = 'block';
                    } else if (error.code === 'PGRST301' || error.message.includes('row-level security')) {
                        // الجدول موجود لكن RLS يمنع الوصول
                        tableExists = true;
                        checks.push({
                            status: 'success',
                            icon: '✅',
                            message: 'جدول users موجود'
                        });
                        checks.push({
                            status: 'info',
                            icon: 'ℹ️',
                            message: 'قواعد RLS مفعلة - تحقق من الصلاحيات في Supabase Dashboard'
                        });
                    } else {
                        checks.push({
                            status: 'warning',
                            icon: '⚠️',
                            message: 'خطأ في الوصول لجدول users: ' + error.message
                        });
                    }
                } else {
                    tableExists = true;
                    checks.push({
                        status: 'success',
                        icon: '✅',
                        message: 'جدول users موجود ويمكن الوصول إليه'
                    });
                }
            } catch (e) {
                checks.push({
                    status: 'error',
                    icon: '❌',
                    message: 'خطأ في فحص الجدول: ' + e.message
                });
            }
            
            // 4. التحقق من المستخدم الحالي
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    checks.push({
                        status: 'success',
                        icon: '✅',
                        message: `مسجل دخول كـ: ${user.email}`
                    });
                    
                    // التحقق من وجود المستخدم في جدول users
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (userData) {
                        checks.push({
                            status: 'success',
                            icon: '✅',
                            message: `بيانات المستخدم موجودة: ${userData.full_name} (${userData.role})`
                        });
                    } else if (userError) {
                        checks.push({
                            status: 'warning',
                            icon: '⚠️',
                            message: 'المستخدم غير موجود في جدول users'
                        });
                    }
                } else {
                    checks.push({
                        status: 'info',
                        icon: 'ℹ️',
                        message: 'لم يتم تسجيل الدخول'
                    });
                }
                
                // إظهار زر إنشاء المستخدم إذا كان مسجل دخول ولكن ليس لديه ملف تعريف
                if (user && !userData && !userError) {
                    document.getElementById('createUserBtn').style.display = 'inline-block';
                }
            } catch (e) {
                checks.push({
                    status: 'error',
                    icon: '❌',
                    message: 'خطأ في فحص المستخدم: ' + e.message
                });
            }
            
            // عرض النتائج
            displayResults(checks);
        }
        
        function displayResults(checks) {
            const resultsDiv = document.getElementById('checkResults');
            
            resultsDiv.innerHTML = checks.map(check => 
                `<div class="check-item ${check.status}">
                    <span class="icon">${check.icon}</span>
                    <span>${check.message}</span>
                </div>`
            ).join('');
            
            // إضافة ملخص
            const hasErrors = checks.some(c => c.status === 'error');
            const summary = hasErrors 
                ? '<div class="check-item error"><span class="icon">❌</span><span>يوجد أخطاء تحتاج إلى إصلاح</span></div>'
                : '<div class="check-item success"><span class="icon">✅</span><span>كل شيء يعمل بشكل صحيح!</span></div>';
            
            resultsDiv.innerHTML = summary + resultsDiv.innerHTML;
        }
        
        // دالة نسخ كود SQL
        function copySQLCode() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('تم نسخ كود SQL بنجاح! الآن الصقه في Supabase SQL Editor');
            }).catch(err => {
                console.error('فشل نسخ الكود:', err);
                alert('فشل نسخ الكود. يرجى نسخه يدوياً');
            });
        }
        
        // دالة إنشاء مستخدم تجريبي
        async function createTestUser() {
            try {
                // الحصول على المستخدم الحالي
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    alert('يجب تسجيل الدخول أولاً!');
                    return;
                }
                
                // التحقق من وجود المستخدم في جدول users
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();
                
                if (existingUser) {
                    alert('المستخدم موجود بالفعل في قاعدة البيانات!');
                    return;
                }
                
                // إنشاء سجل المستخدم
                const { data, error } = await supabase.from('users').insert({
                    id: user.id,
                    email: user.email,
                    full_name: user.user_metadata?.full_name || user.email.split('@')[0],
                    role: user.user_metadata?.role || 'student',
                    created_at: new Date().toISOString(),
                    is_active: true,
                    email_verified: user.email_confirmed_at ? true : false
                });
                
                if (error) {
                    console.error('Error creating user:', error);
                    alert('خطأ في إنشاء المستخدم: ' + error.message);
                } else {
                    alert('تم إنشاء المستخدم بنجاح!');
                    runChecks(); // إعادة تشغيل الفحص
                }
            } catch (error) {
                console.error('Error:', error);
                alert('حدث خطأ: ' + error.message);
            }
        }
        
        // تشغيل الفحص تلقائياً عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', runChecks);
    </script>
</body>
</html>
