<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body class="check-setup-body">
    <div class="check-container">
        <h1>ğŸ” ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
        <p>Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</p>
        
        <div id="checkResults"></div>
        
        <button class="btn-check" onclick="runChecks()">Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ</button>
        <button class="btn-check btn-test-user" onclick="createTestUser()" id="createUserBtn">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
        
        <div id="sqlInstructions">
            <h2>ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h2>
            <p>Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ù„ØµÙ‚Ù‡ ÙÙŠ Supabase SQL Editor:</p>
            <button class="btn-check btn-copy-sql" onclick="copySQLCode()">ğŸ“‹ Ù†Ø³Ø® ÙƒÙˆØ¯ SQL</button>
            <div class="sql-code">
                <pre id="sqlCode">-- Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
CREATE TABLE IF NOT EXISTS public.users (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    full_name TEXT NOT NULL,
    role TEXT NOT NULL CHECK (role IN ('student', 'teacher', 'admin')),
    phone TEXT,
    university TEXT,
    department TEXT,
    year_of_study INTEGER,
    profile_image TEXT,
    bio TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT true,
    email_verified BOOLEAN DEFAULT false
);

-- ØªÙØ¹ÙŠÙ„ Row Level Security
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- Ø¥Ø¶Ø§ÙØ© Ù‚ÙˆØ§Ø¹Ø¯ RLS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
CREATE POLICY "Users can view own profile" ON public.users
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON public.users
    FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Enable insert for authenticated users only" ON public.users
    FOR INSERT WITH CHECK (auth.uid() = id);</pre>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="user-helper.js"></script>
    <script>
        async function runChecks() {
            const resultsDiv = document.getElementById('checkResults');
            resultsDiv.innerHTML = '<div class="check-item info"><span class="icon">â³</span><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span></div>';
            
            const checks = [];
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Supabase
            if (typeof supabase === 'undefined') {
                checks.push({
                    status: 'error',
                    icon: 'âŒ',
                    message: 'Supabase ØºÙŠØ± Ù…Ø­Ù…Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† config.js'
                });
                displayResults(checks);
                return;
            }
            
            // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø£ÙˆÙ„Ø§Ù‹
                if (SUPABASE_ANON_KEY.includes('YOUR_ANON_KEY_HERE') || SUPABASE_ANON_KEY.includes('PLACEHOLDER')) {
                    checks.push({
                        status: 'error',
                        icon: 'âŒ',
                        message: 'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« SUPABASE_ANON_KEY ÙÙŠ config.js Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Supabase Dashboard'
                    });
                    document.getElementById('sqlInstructions').style.display = 'block';
                } else {
                    const { data: testData, error: testError } = await supabase.auth.getSession();
                    if (!testError) {
                        checks.push({
                            status: 'success',
                            icon: 'âœ…',
                            message: 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­'
                        });
                    } else {
                        checks.push({
                            status: 'error',
                            icon: 'âŒ',
                            message: 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase: ' + testError.message
                        });
                    }
                }
            } catch (e) {
                checks.push({
                    status: 'error',
                    icon: 'âŒ',
                    message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + e.message
                });
            }
            
            // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ users
            let tableExists = false;
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        checks.push({
                            status: 'error',
                            icon: 'âŒ',
                            message: 'Ø¬Ø¯ÙˆÙ„ users ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ - ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¤Ù‡'
                        });
                        document.getElementById('sqlInstructions').style.display = 'block';
                    } else if (error.code === 'PGRST301' || error.message.includes('row-level security')) {
                        // Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† RLS ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„
                        tableExists = true;
                        checks.push({
                            status: 'success',
                            icon: 'âœ…',
                            message: 'Ø¬Ø¯ÙˆÙ„ users Ù…ÙˆØ¬ÙˆØ¯'
                        });
                        checks.push({
                            status: 'info',
                            icon: 'â„¹ï¸',
                            message: 'Ù‚ÙˆØ§Ø¹Ø¯ RLS Ù…ÙØ¹Ù„Ø© - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ Supabase Dashboard'
                        });
                    } else {
                        checks.push({
                            status: 'warning',
                            icon: 'âš ï¸',
                            message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ø¯ÙˆÙ„ users: ' + error.message
                        });
                    }
                } else {
                    tableExists = true;
                    checks.push({
                        status: 'success',
                        icon: 'âœ…',
                        message: 'Ø¬Ø¯ÙˆÙ„ users Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡'
                    });
                }
            } catch (e) {
                checks.push({
                    status: 'error',
                    icon: 'âŒ',
                    message: 'Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ' + e.message
                });
            }
            
            // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    checks.push({
                        status: 'success',
                        icon: 'âœ…',
                        message: `Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙƒÙ€: ${user.email}`
                    });
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ users
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (userData) {
                        checks.push({
                            status: 'success',
                            icon: 'âœ…',
                            message: `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø©: ${userData.full_name} (${userData.role})`
                        });
                    } else if (userError) {
                        checks.push({
                            status: 'warning',
                            icon: 'âš ï¸',
                            message: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ users'
                        });
                    }
                } else {
                    checks.push({
                        status: 'info',
                        icon: 'â„¹ï¸',
                        message: 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'
                    });
                }
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙƒÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ
                if (user && !userData && !userError) {
                    document.getElementById('createUserBtn').style.display = 'inline-block';
                }
            } catch (e) {
                checks.push({
                    status: 'error',
                    icon: 'âŒ',
                    message: 'Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + e.message
                });
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            displayResults(checks);
        }
        
        function displayResults(checks) {
            const resultsDiv = document.getElementById('checkResults');
            
            resultsDiv.innerHTML = checks.map(check => 
                `<div class="check-item ${check.status}">
                    <span class="icon">${check.icon}</span>
                    <span>${check.message}</span>
                </div>`
            ).join('');
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ
            const hasErrors = checks.some(c => c.status === 'error');
            const summary = hasErrors 
                ? '<div class="check-item error"><span class="icon">âŒ</span><span>ÙŠÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥ØµÙ„Ø§Ø­</span></div>'
                : '<div class="check-item success"><span class="icon">âœ…</span><span>ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!</span></div>';
            
            resultsDiv.innerHTML = summary + resultsDiv.innerHTML;
        }
        
        // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® ÙƒÙˆØ¯ SQL
        function copySQLCode() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ SQL Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¢Ù† Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Supabase SQL Editor');
            }).catch(err => {
                console.error('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯:', err);
                alert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹');
            });
        }
        
        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ
        async function createTestUser() {
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!');
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ users
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();
                
                if (existingUser) {
                    alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!');
                    return;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const { data, error } = await supabase.from('users').insert({
                    id: user.id,
                    email: user.email,
                    full_name: user.user_metadata?.full_name || user.email.split('@')[0],
                    role: user.user_metadata?.role || 'student',
                    created_at: new Date().toISOString(),
                    is_active: true,
                    email_verified: user.email_confirmed_at ? true : false
                });
                
                if (error) {
                    console.error('Error creating user:', error);
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
                } else {
                    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                    runChecks(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        }
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', runChecks);
    </script>
</body>
</html>
